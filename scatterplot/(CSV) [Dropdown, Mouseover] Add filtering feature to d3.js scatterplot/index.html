<!DOCTYPE html>
<html lang="en">
<head>
  	<meta charset="utf-8">
    <title>Trust and Business</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="https://raw.githubusercontent.com/jaz303/tipsy/master/src/javascripts/jquery.tipsy.js"></script>
	<link href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css"/>
	
	<style type="text/css">
		.axis path, .axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		  opacity: 1;
		}

		.axis text { font-size:10px; }

		body { font: 12px sans-serif; }

		.circles { opacity: .5; }

		.tipsy { font-size:11px; margin-top:-10px;}

		.guide line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		  opacity: 0;
		}
	</style>
</head>


<body>

<div id="chart"></div>

<div id="filter">
    <b>Countries by Region:</b>
</div>

<script type="text/javascript">

var margin = {t:30, r:20, b:20, l:40 },
	w = 600 - margin.l - margin.r,
	h = 500 - margin.t - margin.b,
	x = d3.scale.linear().range([0, w]),
	y = d3.scale.linear().range([h - 60, 0]),
	// COLOR THAT WILL REFLECT GEOGRAPHICAL REGIONS
	color = d3.scale.category10();

var svg = d3.select("#chart").append("svg")
	.attr("width", w + margin.l + margin.r)
	.attr("height", h + margin.t + margin.b);

// SET AXES, AS WELL AS DETAILS ON THEIR TICKS
var xAxis = d3.svg.axis().scale(x)
	.ticks(20).tickSubdivide(true)
	.tickSize(6, 3, 0)
	.orient("bottom");

var yAxis = d3.svg.axis().scale(y)
	.ticks(20).tickSubdivide(true)
	.tickSize(6, 3, 0)
	.orient("left");

var groups = svg.append("g")
			.attr("transform", "translate(" + margin.l + "," + margin.t + ")");

var regions = ["Asia", "Europe", "Middle East", "N. America", "S. America", "Sub-Saharan Africa"];

var dropDown = d3.select("#filter")
			.append("select").attr("name", "country-list");

var options = dropDown.selectAll("option")
	.data(["All"].concat(regions))
	.enter()
	.append("option");

options.text(function (d) { return d; })
   .attr("value", function (d) { return d; });



d3.csv("trust-business.csv", function(data) {

	data.sort(function(a, b) { return d3.ascending(a.region, b.region); })

	var x0 = Math.max(-d3.min(data, function(d) { return d.trust; }), d3.max(data, function(d) { return d.trust; }));
	x.domain([-100, 100]);
	y.domain([180, 0])

	console.log("data:\n", data)

	var circles = groups.selectAll("circle")
		.data(data)
		.enter().append("circle")
		.attr("class", "circles")
		.attr({
			cx: function(d) { return x(+d.trust); },
			cy: function(d) { return y(+d.business); },
			r: 8,
			id: function(d) { return d.country; }
		})
		.style("fill", function(d) { return color(d.region); });



	////// THIS SECTION DEFINES THE GUIDING LINES
	// WHAT TO DO WHEN WE MOUSE OVER A BUBBLE
	var mouseOn = function() {

		var circle = d3.select(this);
		console.log("circle:\n", circle);

		// TRANSITION TO INCREASE SIZE/OPACITY OF BUBBLE
		circle.transition()
			.duration(800).style("opacity", 1)
			.attr("r", 16).ease("elastic");

		// APPEND LINES TO BUBBLES THAT WILL BE USED TO SHOW THE PRECISE DATA POINTS.
		// TRANSLATE THEIR LOCATION BASED ON MARGINS
		svg.append("g")
			.attr("class", "guide")
			.append("line")
				.attr("x1", circle.attr("cx"))
				.attr("x2", circle.attr("cx"))
				.attr("y1", +circle.attr("cy") + 26)
				.attr("y2", h - margin.t - margin.b)
				.attr("transform", "translate(40,20)")
				.style("stroke", circle.style("fill"))
				.transition().delay(200).duration(400)
				.styleTween("opacity", 
							function() { return d3.interpolate(0, .5); });

		svg.append("g")
			.attr("class", "guide")
			.append("line")
				.attr("x1", +circle.attr("cx") - 16)
				.attr("x2", 0)
				.attr("y1", circle.attr("cy"))
				.attr("y2", circle.attr("cy"))
				.attr("transform", "translate(40,30)")
				.style("stroke", circle.style("fill"))
				.transition().delay(200).duration(400)
				.styleTween("opacity", 
							function() { return d3.interpolate(0, .5); });

		// FUNCTION TO MOVE MOUSEOVER ITEM TO FRONT OF SVG STAGE, IN CASE 
		// ANOTHER BUBBLE OVERLAPS IT
		d3.selection.prototype.moveToFront = function() { 
			return this.each(function() { 
				this.parentNode.appendChild(this); 
			}); 
		};

		// SKIP THIS FUNCTIONALITY FOR IE9, WHICH DOESN'T LIKE IT
		if (!$.browser.msie) { circle.moveToFront(); };
	};


	// WHAT HAPPENS WHEN WE LEAVE A BUBBLE?
	var mouseOff = function() {
		var circle = d3.select(this);

		// GO BACK TO ORIGINAL SIZE AND OPACITY
		circle.transition()
			.duration(800).style("opacity", .5)
			.attr("r", 8).ease("elastic");

		// FADE OUT GUIDE LINES, THEN REMOVE THEM
		d3.selectAll(".guide").transition().duration(100)
			.styleTween("opacity", function() { return d3.interpolate(.5, 0); })
			.remove()
	};

	// RUN THE MOUSEON/OUT FUNCTIONS
	circles.on("mouseover", mouseOn);
	circles.on("mouseout", mouseOff);
	////// GUIDING LINES END HERE


	circles.append("title").text(function(d) { return d.country; })

	// TOOLTIPS (USING JQUERY PLUGIN TIPSY)
	$(".circles").tipsy({ gravity: 's', });


	// THE LEGEND COLOR GUIDE
	var legend = svg.selectAll("rect")
				.data(regions)
				.enter().append("rect")
				.attr({
					x: function(d, i) { return (40 + i * 80); },
					y: h,
					width: 25,
					height: 12
				})
				.style("fill", function(d) { return color(d); });

	// LEGEND LABELS
	svg.selectAll("text")
		.data(regions)
		.enter().append("text")
		.attr({
			x: function(d, i) { return (40 + i * 80); },
			y: h + 24,
		})
		.text(function(d) { return d; });


	// DRAW AXES AND AXIS LABELS
	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + margin.l + "," + (h - 60 + margin.t) + ")")
		.call(xAxis);

	svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" + margin.l + "," + margin.t + ")")
		.call(yAxis);

	svg.append("text")
		.attr("class", "x label")
		.attr("text-anchor", "end")
		.attr("x", w + 50)
		.attr("y", h - margin.t - 5)
		.text("others in society seen as trustworthy*");

	svg.append("text")
		.attr("class", "y label")
		.attr("text-anchor", "end")
		.attr("x", -20)
		.attr("y", 45)
		.attr("dy", ".75em")
		.attr("transform", "rotate(-90)")
		.text("ease of doing business (rank)");
		
		
	dropDown.on("change", function() {

		var selected = this.value;
		displayOthers = this.checked ? "inline" : "none";
		display = this.checked ? "none" : "inline";

		if(selected == 'All') {
			svg.selectAll(".circles").attr("display", display);
		}

		else {
			svg.selectAll(".circles")
			    .filter(function(d) {return selected != d.region;})
			    .attr("display", displayOthers);    
			svg.selectAll(".circles")
			    .filter(function(d) {return selected == d.region;})
			    .attr("display", display);
		}
	});
});

</script>
</body>
</html>