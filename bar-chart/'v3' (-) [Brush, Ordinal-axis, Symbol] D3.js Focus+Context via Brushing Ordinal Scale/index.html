<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <style>

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .grid {
            stroke: black;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
            font-family: sans-serif;
            font-size: 11px;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        .point {
            stroke: black;
            shape-rendering: crispEdges;
        }

        .legend {
            stroke: black;
            shape-rendering: crispEdges;
        }

        div.tooltip { 
            position: absolute;     
            text-align: center;     
            width: 175px;         
            height: 23px;         
            padding: 2px;       
            font: 8px sans-serif;   
            background: lightsteelblue; 
            border: 0px;    
            border-radius: 8px;     
            pointer-events: none;     
        }

        .brush .extent {
            stroke: #fff;
            fill-opacity: .125;
            shape-rendering: crispEdges;
        }

        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            vertical-align: top;
            fill: black;
        }

        .svg-content {
            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .hide {
            display: none !important;
        }
    </style>
</head>

<body>

<div id="chart" class="svg-container"></div>

<script>

var data = [
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "S2PF", TYPE_VALUE: 17.137},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "A10X", TYPE_VALUE: 5000},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "S2DT", TYPE_VALUE: 89.51},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "PX10", TYPE_VALUE: 920},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "LC", TYPE_VALUE: 92240},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "P2D", TYPE_VALUE: 72.373},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "DC", TYPE_VALUE: 1.02},
    {SETUP_TIME_STAMP: "2015-04-01 08:54:44.415",    TYPE_CODE:  "PI", TYPE_VALUE: 9500},
    
    {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "S2PF", TYPE_VALUE: 20.137},
        {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "A10X", TYPE_VALUE: 6000},
        {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "S2DT", TYPE_VALUE: 99.51},
        {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "PX10", TYPE_VALUE: 820},
        {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "LC", TYPE_VALUE: 90240},
        {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "P2D", TYPE_VALUE: 82.373},
    {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "DC", TYPE_VALUE: 2.02},
    {SETUP_TIME_STAMP: "2015-05-01 09:54:44.415",    TYPE_CODE:  "PI", TYPE_VALUE: 8500},

    {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "S2PF", TYPE_VALUE: 19.137},
        {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "A10X", TYPE_VALUE: 7000},
        {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "S2DT", TYPE_VALUE: 79.51},
        {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "PX10", TYPE_VALUE: 720},
        {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "LC", TYPE_VALUE: 94240},
        {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "P2D", TYPE_VALUE: 92.373},
    {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "DC", TYPE_VALUE: 0.02},
    {SETUP_TIME_STAMP: "2015-06-01 10:54:44.415",    TYPE_CODE:  "PI", TYPE_VALUE: 7500},

    {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "S2PF", TYPE_VALUE: 19.137},
        {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "A10X", TYPE_VALUE: 7000},
        {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "S2DT", TYPE_VALUE: 79.51},
        {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "PX10", TYPE_VALUE: 720},
        {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "LC", TYPE_VALUE: 94240},
        {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "P2D", TYPE_VALUE: 92.373},
    {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "DC", TYPE_VALUE: 0.02},
    {SETUP_TIME_STAMP: "2015-06-01 10:56:44.415",    TYPE_CODE:  "PI", TYPE_VALUE: 7500},

    {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "S2PF", TYPE_VALUE: 19.137},
        {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "A10X", TYPE_VALUE: 7000},
        {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "S2DT", TYPE_VALUE: 79.51},
        {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "PX10", TYPE_VALUE: 720},
        {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "LC", TYPE_VALUE: 94240},
        {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "P2D", TYPE_VALUE: 92.373},
    {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "DC", TYPE_VALUE: 0.02},
    {SETUP_TIME_STAMP: "2015-06-01 10:57:44.415",    TYPE_CODE:  "PI", TYPE_VALUE: 7500},

    {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "S2PF", TYPE_VALUE: 19.137},
        {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "A10X", TYPE_VALUE: 7000},
        {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "S2DT", TYPE_VALUE: 79.51},
        {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "PX10", TYPE_VALUE: 720},
        {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "LC", TYPE_VALUE: 94240},
        {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "P2D", TYPE_VALUE: 92.373},
    {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "DC", TYPE_VALUE: 0.02},
    {SETUP_TIME_STAMP: "2015-06-01 10:58:44.415",    TYPE_CODE:  "PI", TYPE_VALUE: 7500}
];

console.log("data:", data);


var margin = {top: 100, right: 10, bottom: 85, left: 100},
    margin2 = {top: 800, right: 10, bottom: 5, left: 100},
    width = 1750 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom,
    height2 = 870 - margin2.top - margin2.bottom,
    legendRectSize = 18,
    legendSpacing = 4;

var format = d3.time.format("%Y-%m-%d %H:%M:%S.%L");
var dateFn = function(d) { return format.parse(d.SETUP_TIME_STAMP); };

var symbols = { "S2PF": "square", "A10X": "square", "S2DT": "square", "PX10": "cross", "LC": "cross", "P2D": "square", "DC": "triangle-up", "PI": "square" };

var colors = { "S2PF": "#FFFF00", "A10X": "#CC3399", "S2DT": "#660033", "PX10": "#666666", "LC": "#666666", "P2D": "#FFFFFF", "DC": "#FF3399", "PI": "#FFFFFF" };

var xScale = d3.scale.ordinal()
            .domain(data.map(function(d) { 
                return dateFn(d); }))
            .rangePoints([0, width], .2),
    xScale2 = d3.scale.ordinal()
            .domain(xScale.domain())
            .rangePoints([0, width], .2),
    yScale = d3.scale.log()
            .domain([.001, 1000000])
            .range([height, 0]),
    yScale2 = d3.scale.log()
            .domain([.001, 1000000])
            .range([height2, 0]);

console.log("xScale.domain()/xScale2.domain():", xScale.domain());
console.log("yScale.domain()/yScale2.domain():", yScale.domain());


var xAxis = d3.svg.axis().scale(xScale).orient("bottom").tickFormat(format),
    xAxis2 = d3.svg.axis().scale(xScale2).orient("bottom").tickFormat(format),
    yAxis = d3.svg.axis().scale(yScale)
            .orient("left")
            .tickFormat(
                function(d) {
                    return yScale.tickFormat(10, d3.format(",g"))(d)
            })
            .tickValues([.001, .01, .1, 1, 10, 100, 1000, 10000, 100000, 1000000]);

var brush = d3.svg.brush().x(xScale2).on("brush", brushed);

// Define the div for the tooltip
var div = d3.select("body").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);

// add the graph canvas to the body of the webpage
var svg = d3.select("div#chart")
        .append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 1750 1000")
            .classed("svg-content", true)

svg.append("rect")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("fill", "lightgrey");

// Top View
var focus = svg.append("g")
        .attr("class", "focus")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Bottom View
var context = svg.append("g")
        .attr("class", "context")
        .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

// READING MY REAL DATA (DOESNT WORK ON JSFIDDLE)
// my real data is here: https://raw.githubusercontent.com/brooksandrew/simpleblog/gh-pages/assets/csv/cleanTrips_small.csv

//var dataset=
//d3.csv("../csv/cleanTrips_small.csv", function(error, data) {
//  dataset=data;
//  dataset.forEach(function(d){
//    d['time'] = parseDate(d['time'])
//    d['Minutes'] = +d['Minutes']
//  })
//  initialize();
//});    

// ABBREVIATED DATA VERSION FOR JSFIDDLE
data.forEach(function(d){
        //d['SETUP_TIME_STAMP'] = format(d['SETUP_TIME_STAMP'])
        d['TYPE_VALUE'] = +d['TYPE_VALUE']
})
initialize();

// function that plots!
function initialize() {
    
    var legendData = d3.values(data.map(function(d) { return d.TYPE_CODE; }))
    var unique = legendData.filter(function(elem, pos) { return legendData.indexOf(elem) == pos; })
    
    // Main X-Axis
    focus.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
    .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate (-65)");

    // Draw the y grid lines
    focus.append("g")
        .attr("class", "grid")
        .call(make_y_axis()
            .tickSize(-width, 0, 0)
            .tickFormat(
                function (d) {
                    return yScale.tickFormat(10, d3.format(",g"))(d)
                })
            .tickValues([.001, .01, .1, 1, 10, 100, 1000, 10000, 100000, 1000000])
        )
        .selectAll("text")
        .attr("dx", "-.6em");

    // Main Y-Axis
    focus.append("g")
        .attr("class", "y axis")
        .call(yAxis);

    // Small Grid X-Axis
    context.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height2 + ")")
        .call(xAxis2)
    .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate (-65)");

    // Create Brush Rect
    context.append("g")
        .attr("class", "x brush")
        .call(brush)
        .selectAll("rect")
        .attr("y", 0)
        .attr("height", height2 + 7);

    // draw symbols on top view
    focus.selectAll(".point")
        .data(data)
        .enter().append("path")
        //.attr("class", "point")
        .attr("class", function(d) { return "point " + d.TYPE_CODE + ""; })
        .attr("d", d3.svg.symbol().type(function(d) { return symbols[d.TYPE_CODE]; }))
        .attr("transform", function(d) { return "translate(" + xScale(dateFn(d)) + "," + yScale(d.TYPE_VALUE) +  ")"; })
        .style("fill", function(d) { return colors[d.TYPE_CODE]; })
        .on("mouseover", function(d) {
            // This if statment is because IE fucking sucks, and doesn't take care of mouse events properly.
            if(div.style("opacity") == 0){
                d3.select(this).transition()
                     .duration(300)
                     .attr("d", d3.svg.symbol().type(function(d) { return symbols[d.TYPE_CODE]; }).size(120));
                d3.select(this).moveToFront();
                div.transition()      
                     .duration(200)     
                     .style("opacity", .9);     
                div.html("Setup Time Stamp: " + d.SETUP_TIME_STAMP + "<br/>"  
                             + d.TYPE_CODE + ": " + d.TYPE_VALUE)   
                     .style("left", (d3.event.pageX) + "px")        
                     .style("top", (d3.event.pageY - 28) + "px");   
            }
        })                    
        .on("mouseout", function(d) {     
            d3.select(this).transition()
                 .duration(300)
                 .attr("d", d3.svg.symbol().type(function(d) { return symbols[d.TYPE_CODE]; }));
            div.transition()        
                 .duration(500)       
                 .style("opacity", 0);    
        });

    // Draw symbols on Bottom View
    context.selectAll(".point")
        .data(data)
        .enter().append("path")
        //.attr("class", "point")
        .attr("class", function(d) { return "point " + d.TYPE_CODE + ""; })
        .attr("d", d3.svg.symbol().type(function(d) { return symbols[d.TYPE_CODE]; }))
        .attr("transform", function(d) { return "translate(" + xScale2(dateFn(d)) + "," + yScale2(d.TYPE_VALUE) +  ")"; })
        .style("fill", function(d) { return colors[d.TYPE_CODE]; });
    
    //the global legend
    var globalLegend = svg.selectAll(".legend")//svg.append('g')
            .data(unique)
            .enter().append("g")
            .attr("class", "legend")
            .attr( "transform", function(d, i) { 
                xOff = (i+6 % 8) * 100
                yOff = Math.floor(i / 8) * 20
                return "translate(" + xOff + "," + yOff + 40 + ")"
            });

    globalLegend.append('path')
            .attr("d", d3.svg.symbol().type(function(d) { return symbols[d]; }).size(128))
            .attr('class', 'legend')
            .style("fill", function(d) { return colors[d]; })
            .on("click", function(TYPE_CODE) {
                var symbolClass = "." + TYPE_CODE + "";

                if (d3.selectAll(symbolClass).classed('hide')) {
                    d3.selectAll(symbolClass).classed('hide', false);
                } else {
                    d3.selectAll("" + symbolClass + "")
                        .classed("hide", function(d, i) {
                            return !d3.select(this).classed("hide");
                        });
                }
            });

    globalLegend.append('text')
            .attr("dy", ".35em")
            .attr('dx', '-1em')
            .style("text-anchor", "end")
            .text(function(d) {return d; });

};

// Brush Function
function brushed() {
    var extent = brush.extent();
    var d = xScale2.domain();

console.log("extent", extent);
console.log("d", d);

    /* The brush will cover the symbol, extracting the data
    from there, it will adjust the view */
    var SymbolInside = data.filter(function(d) {
        return extent[0] <= xScale2(dateFn(d)) && xScale2(dateFn(d)) <= extent[1];
    });
    
    SymbolInside = SymbolInside.map(function (d) { return dateFn(d); });

console.log("SymbolInside", SymbolInside);

    
    xScale.domain(brush.empty() ? d : SymbolInside);
    focus.select(".x.axis")
                .call(xAxis)
             .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate (-65)");
    focus.selectAll(".point")
                .attr("d", d3.svg.symbol().type(function(d) { return symbols[d.TYPE_CODE]; }))
                .attr("transform", function(d) { return "translate(" + xScale(dateFn(d)) + "," + yScale(d.TYPE_VALUE) +  ")"; })
                .style("fill", function(d) { return colors[d.TYPE_CODE]; });
}

// function for y grid lines
function make_y_axis(){
    return d3.svg.axis()
        .scale(yScale)
        .orient("left")
        .ticks(9);
};

// function to move object to Front
d3.selection.prototype.moveToFront = function() {  
    return this.each(function(){
        this.parentNode.appendChild(this);
    });
};

// function to move object to Back
d3.selection.prototype.moveToBack = function() {  
    return this.each(function() { 
        var firstChild = this.parentNode.firstChild; 
        if (firstChild) { 
            this.parentNode.insertBefore(this, firstChild); 
        } 
    });
};

</script>

</body>
</html>